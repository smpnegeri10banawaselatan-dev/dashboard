<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <title>Dashboard Data KIB B Peralatan Dan Mesin</title>
  <!-- Tailwind CSS -->
  <script src="https://cdn.tailwindcss.com"></script>
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <!-- Library untuk ekspor -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.28/jspdf.plugin.autotable.min.js"></script>
</head>
<body class="bg-gray-100 p-4">
  <div class="container mx-auto bg-white p-4 rounded-lg shadow-md">
    <h2 class="text-2xl font-bold mb-4 text-center">ðŸ“Š Dashboard Data KIB B Dinas Pendidikan Dan Kebudayaan</h2>

    <!-- Filter Section -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-4">
      <div>
        <label for="filterKec" class="block text-sm font-semibold">Pilih Kecamatan:</label>
        <select id="filterKec" class="form-select w-full"></select>
      </div>
      <div>
        <label for="filterJenjang" class="block text-sm font-semibold">Pilih Jenjang:</label>
        <select id="filterJenjang" class="form-select w-full"></select>
      </div>
      <div>
        <label for="filterStatus" class="block text-sm font-semibold">Pilih Status:</label>
        <select id="filterStatus" class="form-select w-full"></select>
      </div>
    </div>

    <!-- Search -->
    <div class="mb-4">
      <input type="text" id="searchInput" placeholder="ðŸ” Cari data..." class="form-control">
    </div>

    <!-- Button Export -->
    <div class="flex flex-wrap gap-2 mb-6">
      <button id="exportExcel" class="btn btn-success">Ekspor ke Excel</button>
      <button id="exportPDF" class="btn btn-danger">Ekspor ke PDF</button>
    </div>

    <!-- Chart Section -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-6">
      <div class="bg-gray-50 p-4 rounded-lg shadow">
        <h3 class="text-center font-semibold mb-2">Jumlah Barang per Kecamatan</h3>
        <div class="flex justify-center">
          <canvas id="barChart" class="max-w-md w-full h-64"></canvas>
        </div>
      </div>
      <div class="bg-gray-50 p-4 rounded-lg shadow">
        <h3 class="text-center font-semibold mb-2">Jumlah Barang per Jenjang</h3>
        <div class="flex justify-center">
          <canvas id="pieChart" class="max-w-md w-full h-64"></canvas>
        </div>
      </div>
    </div>

    <!-- Table Section -->
    <h3 class="text-xl font-semibold mb-3">ðŸ“‹ Tabel Ringkasan</h3>
    <div class="overflow-x-auto">
      <table id="dataTable" class="table table-bordered table-striped text-sm w-full"></table>
    </div>

    <!-- Pagination -->
    <div class="flex justify-between items-center mt-3">
      <div>
        <label>Tampilkan: 
          <select id="rowsPerPage" class="form-select d-inline-block w-auto">
            <option value="5">5</option>
            <option value="10" selected>10</option>
            <option value="25">25</option>
            <option value="50">50</option>
          </select> baris
        </label>
      </div>
      <div id="paginationControls" class="flex gap-2"></div>
    </div>
  </div>

  <script>
    const sheetId = "1A181-886b4zZZkP46AoIaalOTwBFtuXm2do1s2ui2F4";
    const apiKey = "AIzaSyAT2WG4qREmG2YB1jomTl4tSYntVX7iC4c";
    const range = "Sheet1!A:F";

    let allRows = [];
    let headers = [];
    let filteredRows = [];
    let barChart, pieChart;

    let currentPage = 1;
    let rowsPerPage = 10;

    async function loadData() {
      const url = `https://sheets.googleapis.com/v4/spreadsheets/${sheetId}/values/${range}?key=${apiKey}`;
      const res = await fetch(url);
      const data = await res.json();
      const rows = data.values;

      headers = rows[0];
      allRows = rows.slice(1);
      filteredRows = allRows;

      const kecIndex = headers.indexOf("Kecamatan");
      const jenjangIndex = headers.indexOf("Jenjang");
      const statusIndex = headers.indexOf("Status");

      // isi dropdown
      const kecamatanSet = new Set(allRows.map(r => r[kecIndex]));
      const jenjangSet = new Set(allRows.map(r => r[jenjangIndex]));
      const statusSet = new Set(allRows.map(r => r[statusIndex]));

      const selectKec = document.getElementById("filterKec");
      selectKec.innerHTML = '<option value="ALL">Semua Kecamatan</option>';
      kecamatanSet.forEach(kec => { let opt=document.createElement("option"); opt.value=kec; opt.textContent=kec; selectKec.appendChild(opt); });

      const selectJen = document.getElementById("filterJenjang");
      selectJen.innerHTML = '<option value="ALL">Semua Jenjang</option>';
      jenjangSet.forEach(jen => { let opt=document.createElement("option"); opt.value=jen; opt.textContent=jen; selectJen.appendChild(opt); });

      const selectStatus = document.getElementById("filterStatus");
      selectStatus.innerHTML = '<option value="ALL">Semua Status</option>';
      statusSet.forEach(st => { let opt=document.createElement("option"); opt.value=st; opt.textContent=st; selectStatus.appendChild(opt); });

      renderDashboard("ALL","ALL","ALL");
    }

    function renderDashboard(filterKec, filterJen, filterStatus) {
      const kecIndex = headers.indexOf("Kecamatan");
      const jenjangIndex = headers.indexOf("Jenjang");
      const statusIndex = headers.indexOf("Status");
      const jumlahIndex = headers.indexOf("JUMLAH BARANG");

      // filter data
      filteredRows = allRows.filter(r=>{
        let match = true;
        if (filterKec !== "ALL" && r[kecIndex] !== filterKec) match = false;
        if (filterJen !== "ALL" && r[jenjangIndex] !== filterJen) match = false;
        if (filterStatus !== "ALL" && r[statusIndex] !== filterStatus) match = false;
        return match;
      });

      // search filter
      const keyword = document.getElementById("searchInput").value.toLowerCase();
      if (keyword) {
        filteredRows = filteredRows.filter(r=> r.join(" ").toLowerCase().includes(keyword));
      }

      renderTable();
      
      // agregasi jumlah barang per kecamatan
      const aggKec = {};
      filteredRows.forEach(r=>{
        const kec = r[kecIndex];
        const val = parseInt(r[jumlahIndex]) || 0;
        aggKec[kec] = (aggKec[kec]||0) + val;
      });

      // agregasi jumlah barang per jenjang
      const aggJenjang = {};
      filteredRows.forEach(r=>{
        const jen = r[jenjangIndex];
        const val = parseInt(r[jumlahIndex]) || 0;
        aggJenjang[jen] = (aggJenjang[jen]||0) + val;
      });

      const labelsKec = Object.keys(aggKec);
      const valuesKec = Object.values(aggKec);
      const labelsJen = Object.keys(aggJenjang);
      const valuesJen = Object.values(aggJenjang);

      // update chart
      if (barChart) barChart.destroy();
      if (pieChart) pieChart.destroy();

      barChart = new Chart(document.getElementById("barChart"), {
        type: 'bar',
        data: { labels: labelsKec, datasets: [{ label: 'Jumlah Barang', data: valuesKec, backgroundColor: 'steelblue' }] },
        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false } } }
      });

      pieChart = new Chart(document.getElementById("pieChart"), {
        type: 'pie',
        data: { labels: labelsJen, datasets: [{ data: valuesJen, backgroundColor: ['#f87171','#34d399','#60a5fa','#fbbf24','#a78bfa','#14b8a6'] }] },
        options: { responsive: true, maintainAspectRatio: false }
      });
    }

    function renderTable() {
      const table = document.getElementById("dataTable");
      table.innerHTML = "<thead><tr>" + headers.map(h=>`<th>${h}</th>`).join("") + "</tr></thead><tbody></tbody>";
      const tbody = table.querySelector("tbody");

      rowsPerPage = parseInt(document.getElementById("rowsPerPage").value);
      const start = (currentPage-1)*rowsPerPage;
      const end = start+rowsPerPage;
      const pageRows = filteredRows.slice(start,end);

      pageRows.forEach(r=>{
        tbody.innerHTML += "<tr>" + r.map(c=>`<td>${c}</td>`).join("") + "</tr>";
      });

      renderPagination();
    }

    function renderPagination() {
      const totalPages = Math.ceil(filteredRows.length / rowsPerPage);
      const container = document.getElementById("paginationControls");
      container.innerHTML = "";

      const prevBtn = document.createElement("button");
      prevBtn.textContent = "Â« Prev";
      prevBtn.className = "btn btn-outline-primary btn-sm";
      prevBtn.disabled = currentPage===1;
      prevBtn.onclick = ()=>{ currentPage--; renderTable(); };
      container.appendChild(prevBtn);

      const pageInfo = document.createElement("span");
      pageInfo.textContent = ` Halaman ${currentPage} dari ${totalPages} `;
      container.appendChild(pageInfo);

      const nextBtn = document.createElement("button");
      nextBtn.textContent = "Next Â»";
      nextBtn.className = "btn btn-outline-primary btn-sm";
      nextBtn.disabled = currentPage===totalPages;
      nextBtn.onclick = ()=>{ currentPage++; renderTable(); };
      container.appendChild(nextBtn);
    }

    // Event filter & search
    document.getElementById("filterKec").addEventListener("change", ()=>{ currentPage=1; renderDashboard(filterKec.value, filterJenjang.value, filterStatus.value); });
    document.getElementById("filterJenjang").addEventListener("change", ()=>{ currentPage=1; renderDashboard(filterKec.value, filterJenjang.value, filterStatus.value); });
    document.getElementById("filterStatus").addEventListener("change", ()=>{ currentPage=1; renderDashboard(filterKec.value, filterJenjang.value, filterStatus.value); });
    document.getElementById("searchInput").addEventListener("input", ()=>{ currentPage=1; renderDashboard(filterKec.value, filterJenjang.value, filterStatus.value); });
    document.getElementById("rowsPerPage").addEventListener("change", ()=>{ currentPage=1; renderTable(); });

    // ekspor Excel
    document.getElementById("exportExcel").addEventListener("click", ()=>{
      const table = document.getElementById("dataTable");
      const wb = XLSX.utils.table_to_book(table, {sheet:"Data"});
      XLSX.writeFile(wb, "dashboard.xlsx");
    });

    // ekspor PDF
    document.getElementById("exportPDF").addEventListener("click", ()=>{
      const { jsPDF } = window.jspdf;
      const doc = new jsPDF();
      doc.text("Ringkasan Data", 14, 15);
      doc.autoTable({ html: '#dataTable', startY: 20 });
      doc.save("dashboard.pdf");
    });

    loadData();
  </script>
</body>
</html>
